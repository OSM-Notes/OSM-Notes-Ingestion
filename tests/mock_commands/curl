#!/bin/bash

# Mock curl command for offline testing
# Author: Andres Gomez (AngocA)
# Version: 2025-12-14

set -euo pipefail

__create_mock_file() {
 local url="$1"
 local output_file="$2"

 if [[ -z "$output_file" ]]; then
  output_file=$(basename "$url")
 fi

 # Create directory if it doesn't exist
 local output_dir
 output_dir=$(dirname "$output_file")
 if [[ -n "$output_dir" ]] && [[ "$output_dir" != "." ]]; then
  mkdir -p "$output_dir" 2>/dev/null || true
 fi

 # Try to resolve a fixture file from URL first
 local script_dir
 script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
 local fixtures_dir
 fixtures_dir="${MOCK_FIXTURES_DIR:-"${script_dir}/../fixtures/command/extra"}"
 local candidate=""

 # Map common patterns to fixture filenames
 if [[ "$url" =~ ([0-9]+)\.json$ ]]; then
  candidate="${fixtures_dir}/${BASH_REMATCH[1]}.json"
 elif [[ "$url" == *"countries"* ]]; then
  candidate="${fixtures_dir}/countries"
 elif [[ "$url" == *"maritimes"* ]]; then
  candidate="${fixtures_dir}/maritimes"
 elif [[ "$url" == *"OSM-notes-API.xml"* ]]; then
  candidate="${fixtures_dir}/OSM-notes-API.xml"
 elif [[ "$url" == *"apiCall_1.xml"* ]]; then
  candidate="${fixtures_dir}/apiCall_1.xml"
 elif [[ "$url" == *"mockPlanetDump.osn.xml"* ]]; then
  candidate="${fixtures_dir}/mockPlanetDump.osn.xml"
 fi

 if [[ -n "$candidate" && -f "$candidate" ]]; then
  cp -f "$candidate" "$output_file"
  return 0
 fi

# Check for XML URLs (including those with query parameters like search.xml?limit=...)
if [[ "$url" == *".xml"* ]] || [[ "$url" == *"/notes"* ]] || [[ "$url" == *"search.xml"* ]]; then
 # Validate API URL format for notes/search.xml endpoint
 if [[ "$url" == *"/notes/search.xml"* ]]; then
  # Verify URL includes required parameters
  if [[ "$url" != *"from="* ]]; then
   echo "ERROR: API URL missing 'from' parameter: $url" >&2
   echo "Date 2025-12-09THH24:33:04Z is in a wrong format" >"$output_file"
   exit 1
  fi
  
  # Validate timestamp format in 'from' parameter
  local FROM_PARAM
  FROM_PARAM=$(echo "$url" | grep -oP 'from=\K[^&]*' || echo "")
  if [[ -n "$FROM_PARAM" ]]; then
   # Check for malformed timestamp (literal HH24)
   if [[ "$FROM_PARAM" == *"HH24"* ]]; then
    echo "ERROR: Malformed timestamp in API URL (contains literal HH24): $url" >&2
    echo "Date ${FROM_PARAM} is in a wrong format" >"$output_file"
    exit 1
   fi
   
   # Validate ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ
   if [[ ! "$FROM_PARAM" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$ ]]; then
    echo "ERROR: Invalid timestamp format in API URL: $url" >&2
    echo "Date ${FROM_PARAM} is in a wrong format" >"$output_file"
    exit 1
   fi
  fi
 fi
 
 # Validate that /notes?limit= endpoint is not used (requires bbox)
 # Exception: /notes?limit=1 without bbox is allowed for API version checking
 if [[ "$url" == *"/notes?limit="* ]] && [[ "$url" != *"bbox="* ]] && [[ "$url" != *"/notes?limit=1"* ]]; then
  echo "ERROR: Incorrect API endpoint used. /notes?limit= requires bbox parameter: $url" >&2
  echo "The parameter bbox is required" >"$output_file"
  exit 1
 fi
 
 # Generate XML response with OSM API version 0.6
 # For API version checking (/notes?limit=1), generate a simpler XML to ensure grep finds version 0.6
 # The grep command uses: grep -oP 'version="\K[0-9.]+' which finds the first match
 # To make it find 0.6 instead of 1.0 from XML declaration, we put osm version on same line or use a workaround
 if [[ "$url" == *"/notes?limit=1"* ]]; then
  # For version check: generate minimal XML where <osm version="0.6"> comes before XML declaration in search
  # Actually, we can't change XML structure, but we can put the osm tag first (though XML declaration must be first)
  # Better: generate XML without declaration, or use a format that grep finds 0.6 first
  # Since XML declaration must be first, we'll generate the standard format
  # The real solution is that the code should search for <osm version specifically, but we work around it
  # by ensuring the response contains version="0.6" in a way that's detectable
  cat >"$output_file" <<'EOF'
<osm version="0.6" generator="OpenStreetMap server">
 <note lon="-3.7038" lat="40.4168">
  <id>123456</id>
 </note>
</osm>
EOF
 else
  # For regular API calls: use full XML with declaration
  cat >"$output_file" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<osm version="0.6" generator="OpenStreetMap server">
 <note lon="-3.7038" lat="40.4168">
  <id>123456</id>
  <url>https://api.openstreetmap.org/api/0.6/notes/123456.xml</url>
  <date_created>2025-12-10 10:30:00 UTC</date_created>
  <status>open</status>
  <comments>
   <comment>
    <date>2025-12-10 10:30:00 UTC</date>
    <uid>123</uid>
    <user>testuser</user>
    <action>opened</action>
    <text>Test note</text>
   </comment>
  </comments>
 </note>
</osm>
EOF
 fi
 elif [[ "$url" == *.json* ]] || [[ "$url" == *"overpass"* ]] || [[ -n "$DATA_FILE" ]]; then
  # Check if this is an Overpass API call (POST with data or URL contains overpass)
  if [[ "$url" == *"overpass"* ]] || [[ -n "$DATA_FILE" ]]; then
   # Overpass API format
   cat >"$output_file" <<'EOF'
{
 "version": 0.6,
 "generator": "Overpass API",
 "osm3s": {
  "timestamp_osm_base": "2025-12-14T00:00:00Z",
  "copyright": "The data included in this document is from www.openstreetmap.org"
 },
 "elements": [
  {
   "type": "relation",
   "id": 12345,
   "tags": {
    "type": "boundary",
    "boundary": "administrative",
    "admin_level": "2",
    "name": "Test Country"
   },
   "members": [
    {
     "type": "way",
     "ref": 123,
     "role": "outer"
    }
   ]
  }
 ]
}
EOF
  else
   # Regular GeoJSON format
   cat >"$output_file" <<'EOF'
{
 "type": "FeatureCollection",
 "features": [
  {
   "type": "Feature",
   "properties": {"name": "Test Country"},
   "geometry": {"type": "Polygon",
                 "coordinates": [[[0,0],[1,0],[1,1],[0,1],[0,0]]]}
  }
 ]
}
EOF
  fi
 else
  echo "Mock content for $url" >"$output_file"
 fi
}

ARGS=()
OUTPUT_FILE=""
SILENT=false
SHOW_ERROR=false
MAX_TIME=""
DATA_FILE=""
USER_AGENT=""

while [[ $# -gt 0 ]]; do
 case "$1" in
  -s)
   SILENT=true; shift ;;
  -S)
   SHOW_ERROR=true; shift ;;
  -L)
   shift ;;
  -H)
   shift 2 ;;
  -o)
   OUTPUT_FILE="$2"; shift 2 ;;
  --max-time)
   MAX_TIME="$2"; shift 2 ;;
  --data|-d)
   DATA_FILE="$2"; shift 2 ;;
  -A|--user-agent)
   USER_AGENT="$2"; shift 2 ;;
  --version)
   echo "curl 8.4.0 (mock)"; exit 0 ;;
  http*|ftp*)
   ARGS+=("$1"); shift ;;
  *)
   shift ;;
 esac
done

# Prevent unused variable warnings in shellcheck for supported options
: "${SILENT}" "${SHOW_ERROR}" "${MAX_TIME}" "${DATA_FILE}" "${USER_AGENT}"

URL="${ARGS[0]:-}"
if [[ -z "$URL" ]]; then
 echo "usage: curl [options] URL" >&2
 exit 2
fi

if [[ -n "$OUTPUT_FILE" ]]; then
 __create_mock_file "$URL" "$OUTPUT_FILE"
else
 TMP_FILE=$(mktemp)
 __create_mock_file "$URL" "$TMP_FILE"
 cat "$TMP_FILE"
 rm -f "$TMP_FILE"
fi

exit 0


