#!/bin/bash

# Mock curl command for offline testing
# Author: Andres Gomez (AngocA)
# Version: 2025-12-12

set -euo pipefail

__create_mock_file() {
 local url="$1"
 local output_file="$2"

 if [[ -z "$output_file" ]]; then
  output_file=$(basename "$url")
 fi

 # Try to resolve a fixture file from URL first
 local script_dir
 script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
 local fixtures_dir
 fixtures_dir="${MOCK_FIXTURES_DIR:-"${script_dir}/../fixtures/command/extra"}"
 local candidate=""

 # Map common patterns to fixture filenames
 if [[ "$url" =~ ([0-9]+)\.json$ ]]; then
  candidate="${fixtures_dir}/${BASH_REMATCH[1]}.json"
 elif [[ "$url" == *"countries"* ]]; then
  candidate="${fixtures_dir}/countries"
 elif [[ "$url" == *"maritimes"* ]]; then
  candidate="${fixtures_dir}/maritimes"
 elif [[ "$url" == *"OSM-notes-API.xml"* ]]; then
  candidate="${fixtures_dir}/OSM-notes-API.xml"
 elif [[ "$url" == *"apiCall_1.xml"* ]]; then
  candidate="${fixtures_dir}/apiCall_1.xml"
 elif [[ "$url" == *"mockPlanetDump.osn.xml"* ]]; then
  candidate="${fixtures_dir}/mockPlanetDump.osn.xml"
 fi

 if [[ -n "$candidate" && -f "$candidate" ]]; then
  cp -f "$candidate" "$output_file"
  return 0
 fi

# Check for XML URLs (including those with query parameters like search.xml?limit=...)
if [[ "$url" == *".xml"* ]] || [[ "$url" == *"/notes"* ]] || [[ "$url" == *"search.xml"* ]]; then
 # Validate API URL format for notes/search.xml endpoint
 if [[ "$url" == *"/notes/search.xml"* ]]; then
  # Verify URL includes required parameters
  if [[ "$url" != *"from="* ]]; then
   echo "ERROR: API URL missing 'from' parameter: $url" >&2
   echo "Date 2025-12-09THH24:33:04Z is in a wrong format" >"$output_file"
   exit 1
  fi
  
  # Validate timestamp format in 'from' parameter
  local FROM_PARAM
  FROM_PARAM=$(echo "$url" | grep -oP 'from=\K[^&]*' || echo "")
  if [[ -n "$FROM_PARAM" ]]; then
   # Check for malformed timestamp (literal HH24)
   if [[ "$FROM_PARAM" == *"HH24"* ]]; then
    echo "ERROR: Malformed timestamp in API URL (contains literal HH24): $url" >&2
    echo "Date ${FROM_PARAM} is in a wrong format" >"$output_file"
    exit 1
   fi
   
   # Validate ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ
   if [[ ! "$FROM_PARAM" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$ ]]; then
    echo "ERROR: Invalid timestamp format in API URL: $url" >&2
    echo "Date ${FROM_PARAM} is in a wrong format" >"$output_file"
    exit 1
   fi
  fi
 fi
 
 # Validate that /notes?limit= endpoint is not used (requires bbox)
 if [[ "$url" == *"/notes?limit="* ]] && [[ "$url" != *"bbox="* ]]; then
  echo "ERROR: Incorrect API endpoint used. /notes?limit= requires bbox parameter: $url" >&2
  echo "The parameter bbox is required" >"$output_file"
  exit 1
 fi
 
 cat >"$output_file" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<osm version="0.6" generator="OpenStreetMap server">
 <note lon="-3.7038" lat="40.4168">
  <id>123456</id>
  <url>https://api.openstreetmap.org/api/0.6/notes/123456.xml</url>
  <date_created>2025-12-10 10:30:00 UTC</date_created>
  <status>open</status>
  <comments>
   <comment>
    <date>2025-12-10 10:30:00 UTC</date>
    <uid>123</uid>
    <user>testuser</user>
    <action>opened</action>
    <text>Test note</text>
   </comment>
  </comments>
 </note>
</osm>
EOF
 elif [[ "$url" == *.json* ]]; then
  cat >"$output_file" <<'EOF'
{
 "type": "FeatureCollection",
 "features": [
  {
   "type": "Feature",
   "properties": {"name": "Test Country"},
   "geometry": {"type": "Polygon",
                 "coordinates": [[[0,0],[1,0],[1,1],[0,1],[0,0]]]}
  }
 ]
}
EOF
 else
  echo "Mock content for $url" >"$output_file"
 fi
}

ARGS=()
OUTPUT_FILE=""
SILENT=false
SHOW_ERROR=false
MAX_TIME=""
DATA_FILE=""
USER_AGENT=""

while [[ $# -gt 0 ]]; do
 case "$1" in
  -s)
   SILENT=true; shift ;;
  -S)
   SHOW_ERROR=true; shift ;;
  -L)
   shift ;;
  -H)
   shift 2 ;;
  -o)
   OUTPUT_FILE="$2"; shift 2 ;;
  --max-time)
   MAX_TIME="$2"; shift 2 ;;
  --data|-d)
   DATA_FILE="$2"; shift 2 ;;
  -A|--user-agent)
   USER_AGENT="$2"; shift 2 ;;
  --version)
   echo "curl 8.4.0 (mock)"; exit 0 ;;
  http*|ftp*)
   ARGS+=("$1"); shift ;;
  *)
   shift ;;
 esac
done

# Prevent unused variable warnings in shellcheck for supported options
: "${SILENT}" "${SHOW_ERROR}" "${MAX_TIME}" "${DATA_FILE}" "${USER_AGENT}"

URL="${ARGS[0]:-}"
if [[ -z "$URL" ]]; then
 echo "usage: curl [options] URL" >&2
 exit 2
fi

if [[ -n "$OUTPUT_FILE" ]]; then
 __create_mock_file "$URL" "$OUTPUT_FILE"
else
 TMP_FILE=$(mktemp)
 __create_mock_file "$URL" "$TMP_FILE"
 cat "$TMP_FILE"
 rm -f "$TMP_FILE"
fi

exit 0


