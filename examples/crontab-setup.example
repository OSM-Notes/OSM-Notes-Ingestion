# Crontab Configuration Example for OSM Notes Ingestion
# ========================================================
#
# ⚠️ IMPORTANT: API NOTES PROCESSING IS NOW HANDLED BY DAEMON MODE
#
# This file shows cron configuration for MAINTENANCE and MONITORING tasks only.
# The main API notes processing is handled by the daemon (processAPINotesDaemon.sh)
# via systemd service, NOT via cron.
#
# For production deployments, the daemon mode is REQUIRED:
# - examples/systemd/osm-notes-ingestion-daemon.service
# - docs/Process_API.md "Daemon Mode" section
#
# This crontab file is ONLY for:
# - Maintenance tasks (country boundaries updates)
# - Monitoring tasks (data verification, performance analysis)
# - NOT for API notes processing (handled by daemon)
#
# Author: Andres Gomez (AngocA)
# Version: 2025-12-28

# =============================================================================
# PRODUCTION CRON CONFIGURATION
# =============================================================================
#
# This configuration is for maintenance and monitoring tasks that run
# periodically. The main API notes processing runs as a daemon via systemd.
#
# IMPORTANT: Do NOT add processAPINotes.sh to cron. It is now handled by
# the daemon (processAPINotesDaemon.sh) via systemd service.

# =============================================================================
# MAINTENANCE TASKS
# =============================================================================

# Country boundaries update: Once a month (first day at 2 AM)
# Updates country and maritime boundaries from Overpass API
# NOTE: Do NOT use --base flag here. The --base flag is only used automatically
# during initial setup by processPlanetNotes.sh --base.
0 2 1 * * /home/notes/OSM-Notes-Ingestion/bin/process/updateCountries.sh

# =============================================================================
# MONITORING TASKS
# =============================================================================

# Data verification and correction: Check differences between Planet and API notes
# Runs daily at 6 AM to:
# - Correct problems identified with API calls (missing notes/comments)
# - Identify and mark hidden notes that can only be detected with Planet dump
# - Insert missing data from Planet into main database tables
# - Mark notes as hidden that exist in system but not in Planet
# Note: It's normal for this script to do nothing if tables are already correct.
# Only sends email if differences are found.
0 6 * * * EMAILS="notes@osm.lat" /home/notes/OSM-Notes-Ingestion/bin/monitor/notesCheckVerifier.sh

# Database performance analysis: Monthly (first day at 3 AM, after updateCountries)
# Analyzes database performance and generates reports
# NOTE: Create logs directory first: mkdir -p /home/notes/logs
0 3 1 * * /home/notes/OSM-Notes-Ingestion/bin/monitor/analyzeDatabasePerformance.sh --db notes > /home/notes/logs/db_performance_monthly_$(date +\%Y\%m\%d).log 2>&1

# Alternative: Weekly performance analysis (Sunday at 3 AM)
# 0 3 * * 0 /home/notes/OSM-Notes-Ingestion/bin/monitor/analyzeDatabasePerformance.sh --db notes > /home/notes/logs/db_performance_weekly_$(date +\%Y\%m\%d).log 2>&1


# =============================================================================
# IMPORTANT NOTES
# =============================================================================
#
# - processAPINotesDaemon.sh: Runs as a systemd service (daemon mode).
#   This is the MAIN process that handles API notes ingestion continuously.
#   Do NOT add processAPINotes.sh to cron - it is replaced by the daemon.
#
# - processPlanetNotes.sh: Automatically called by the daemon when needed:
#   1. Initial setup: Missing base tables detected
#   2. Regular sync: API limit (10,000 notes) reached + new Planet dump available
#   Do NOT add processPlanetNotes.sh to cron.
#
# - updateCountries.sh: Monthly maintenance task to update country boundaries.
#   Do NOT use --base flag in cron - it would delete and recreate all data.
#
# - notesCheckVerifier.sh: Daily verification and correction script that:
#   * Corrects problems identified with API calls (inserts missing notes/comments)
#   * Identifies and marks hidden notes (only detectable with Planet dump)
#   * Inserts missing data from Planet into main database tables
#   * Marks notes as hidden that exist in system but not in Planet
#   It's normal for this script to do nothing if tables are already correct.
#   Only sends email if differences are found.
#
# - analyzeDatabasePerformance.sh: Monthly/weekly performance analysis.
#   Safe to run on production (uses ROLLBACK, doesn't modify data).


# =============================================================================
# INSTALLATION INSTRUCTIONS
# =============================================================================

# 1. First, set up the daemon (REQUIRED for API notes processing):
#    See examples/systemd/osm-notes-ingestion-daemon.service
#    This handles all API notes ingestion automatically.

# 2. Then, edit your crontab for maintenance/monitoring tasks:
#    crontab -e

# 3. Copy the maintenance and monitoring configuration from above

# 4. Adjust the paths to match your installation:
#    Replace /home/notes/OSM-Notes-Ingestion/ with your actual path

# 5. Create logs directory (if using persistent logs):
#    mkdir -p /home/notes/logs

# 6. Test your configuration:
#    # Test country update manually
#    /home/notes/OSM-Notes-Ingestion/bin/process/updateCountries.sh
#    
#    # Test verification manually
#    /home/notes/OSM-Notes-Ingestion/bin/monitor/notesCheckVerifier.sh
#    
#    # Check crontab syntax
#    crontab -l


# =============================================================================
# MONITORING AND TROUBLESHOOTING
# =============================================================================

# Monitor daemon logs (API notes processing):
# tail -f /tmp/processAPINotesDaemon_*/processAPINotesDaemon.log

# Monitor maintenance task logs:
# tail -f /tmp/updateCountries_*/updateCountries.log
# tail -f /tmp/notesCheckVerifier_*/notesCheckVerifier.log

# Monitor database performance logs:
# tail -f /home/notes/logs/db_performance_*.log

# Check if daemon is running:
# systemctl status osm-notes-ingestion-daemon
# ps aux | grep processAPINotesDaemon

# Check daemon status and recent activity:
# systemctl status osm-notes-ingestion-daemon
# journalctl -u osm-notes-ingestion-daemon -f

# Verify crontab is working:
# crontab -l
# grep CRON /var/log/syslog | tail -10
