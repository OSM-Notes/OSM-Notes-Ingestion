# Alert Configuration Example for OSM Notes Ingestion
# =====================================================
# 
# Alerts are now sent IMMEDIATELY when an error occurs,
# you don't need to configure an external monitoring script.
#
# IMPORTANT: Alert properties are configured in etc/properties.sh
#
# Author: Andres Gomez (AngocA)
# Version: 2025-10-22

# =============================================================================
# OPTION 1: Email Only (Recommended for most users)
# =============================================================================

# Edit etc/properties.sh and configure:

# ADMIN_EMAIL="admin@example.com"
# SEND_ALERT_EMAIL="true"  # Already enabled by default

# The daemon runs automatically as a systemd service.
# When it fails, you will receive an email immediately with:
# - Error description
# - Error code
# - Required actions to fix it
# - Log file location


# =============================================================================
# OPTION 2: No Alerts (Failed file only)
# =============================================================================

# Edit etc/properties.sh and disable all alerts:

# SEND_ALERT_EMAIL="false"

# The daemon will still create the failed file but won't send alerts
# (when SEND_ALERT_EMAIL="false" is configured)

# Useful for:
# - Development/testing environments
# - When using an external monitoring system
# - When you don't have mail configured


# =============================================================================
# DAEMON CONFIGURATION (REQUIRED)
# =============================================================================

# Alert properties are automatically loaded from etc/properties.sh
# The daemon (processAPINotesDaemon.sh) runs as a systemd service, not via cron.

# Set up the daemon service:
# See examples/systemd/osm-notes-api-daemon.service
# sudo cp examples/systemd/osm-notes-api-daemon.service /etc/systemd/system/
# sudo systemctl daemon-reload
# sudo systemctl enable osm-notes-api-daemon
# sudo systemctl start osm-notes-api-daemon

# Alerts will work automatically according to the configuration in etc/properties.sh
# The daemon will send alerts immediately when errors occur.


# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================

# The system uses mutt to send emails. mutt is a required prerequisite that
# is validated during the prerequisites check. mutt works well with external
# SMTP servers and can send emails directly without requiring Postfix
# configuration.

# Install mutt (required):

# Ubuntu/Debian:
# sudo apt-get install mutt

# Test that mutt works manually:
# echo "Test email" | mutt -s "Test" your@email.com

# If you don't receive emails, check:
# 1. Verify mutt is installed: command -v mutt
# 2. Verify mutt has SMTP support: mutt -v | grep -i smtp
# 3. Test sending manually: echo "Test" | mutt -s "Test" your@email.com
# 4. Check script logs for email sending errors


# =============================================================================
# ALERT EXAMPLES
# =============================================================================

# Example 1: Historical data error
# ------------------------------------
# Subject: ALERT: OSM Notes processAPINotes Failed - hostname
# 
# Error code: 248
# Error: Historical data validation failed - base tables exist but contain 
#        no historical data
# 
# Action Required:
# Run processPlanetNotes.sh to load historical data: 
# /home/notes/OSM-Notes-Ingestion/bin/process/processPlanetNotes.sh
# 
# Recovery Steps:
# 1. Run: ./processPlanetNotes.sh
# 2. Delete marker: rm /tmp/processAPINotes_failed_execution
# 3. Retry


# Example 2: XML validation error
# -----------------------------------
# Subject: ALERT: OSM Notes processAPINotes Failed - hostname
# 
# Error code: 249
# Error: XML structure validation failed - downloaded file does not match schema
# 
# Action Required:
# Check if OSM API has changed. Verify file against schema.
# 
# Recovery Steps:
# 1. Check OSM API status
# 2. Verify XML file manually
# 3. If temporary, delete marker and retry


# =============================================================================
# TEMPORARILY DISABLE ALERTS
# =============================================================================

# If you need to temporarily disable alerts (e.g., during maintenance):

# Method 1: Environment variable (configure in etc/properties.sh)
# SEND_ALERT_EMAIL="false"
# Then restart the daemon: sudo systemctl restart osm-notes-api-daemon

# Method 2: In the properties file (recommended)
# Edit etc/properties.sh and change:
# export SEND_ALERT_EMAIL="${SEND_ALERT_EMAIL:-true}"
# to:
# export SEND_ALERT_EMAIL="${SEND_ALERT_EMAIL:-false}"


# =============================================================================
# TROUBLESHOOTING
# =============================================================================

# I don't receive emails
# -----------------------
# 1. Verify that mail is installed:
#    command -v mail
# 
# 2. Test sending an email manually:
#    echo "Test" | mail -s "Test" your@email.com
# 
# 3. Check the daemon logs:
#    tail -f /tmp/processAPINotesDaemon_*/processAPINotesDaemon.log
#    # Or use journalctl:
#    journalctl -u osm-notes-api-daemon -f
#    # Look for: "Email alert sent successfully" or "Failed to send email"
# 
# 4. Check Postfix logs (system logs, requires root or sudo):
#    tail -f /var/log/mail.log
#    Note: /var/log/mail.log is a system log file (Postfix mail server), not a project log


# Alerts are sent but don't arrive
# ----------------------------------
# 1. Check spam/junk folder
# 2. Verify that the destination email is correct
# 3. Check server email whitelist/blacklist


# =============================================================================
# NEW SYSTEM ADVANTAGES
# =============================================================================

# ✓ IMMEDIATE alerts (you don't wait 10-15 minutes)
# ✓ No external monitoring scripts needed
# ✓ No additional cron configuration
# ✓ Simpler and more direct
# ✓ Less system resources
# ✓ Easy to configure (just environment variables)
# ✓ Integrates with existing failed file mechanism


# =============================================================================
# MIGRATION FROM EXTERNAL MONITORING SYSTEM
# =============================================================================

# If you were using checkFailedExecution.sh:

# 1. The external monitoring script is still valid as backup
# 2. You can keep it for additional monitoring if you want
# 3. Or you can remove it from crontab if you prefer only immediate alerts:
#    crontab -e
#    # Comment or remove the checkFailedExecution.sh line

# 4. Configure the new immediate alerts:
#    export ADMIN_EMAIL="admin@example.com"

# 5. Immediate alerts are faster and more efficient